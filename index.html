<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benny</title>

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="/image/logo.jpg">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0a0f;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #curtains {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, #8b0000 0%, #dc143c 50%, #8b0000 100%);
            transition: transform 1.5s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .curtain::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(0,0,0,0.1) 50px, rgba(0,0,0,0.1) 60px);
        }

        .curtain-left { left: 0; }
        .curtain-right { right: 0; }

        #curtains.open .curtain-left { transform: translateX(-100%); }
        #curtains.open .curtain-right { transform: translateX(100%); }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #loading-overlay.hidden { opacity: 0; }

        #loading-text {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            color: #ffea00;
            text-shadow: 0 0 20px #ffea00, 0 0 40px #ffea00;
            margin-bottom: 2rem;
            letter-spacing: 0.3rem;
        }

        #loading-bar-container {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        #loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffea00, #ff2d95);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        #loading-percent {
            color: #fff;
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #ui-layer > * { pointer-events: auto; }


        /* REMOVIDO - Sistema de piadas */
        #joke-display {
            display: none !important;
        }

        #joke-text {
            display: none !important;
        }

        #nav-buttons {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffffff;
        }

        /* Anima√ß√£o de flutua√ß√£o sutil para About panel (subir e descer 5px) */
        @keyframes floatAbout {
            0%, 100% {
                transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(8deg);
            }
            50% {
                transform: perspective(1000px) translateY(calc(-50% - 5px)) translateX(0) rotateY(8deg);
            }
        }

        /* Anima√ß√£o de flutua√ß√£o sutil para Community panel (subir e descer 5px) */
        @keyframes floatCommunity {
            0%, 100% {
                transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(-8deg);
            }
            50% {
                transform: perspective(1000px) translateY(calc(-50% - 5px)) translateX(0) rotateY(-8deg);
            }
        }

        .panel {
            position: fixed;
            top: 50%;
            width: 350px;
            max-height: 70vh;
            padding: 32px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.8), -5px -5px 20px rgba(255, 255, 255, 0.05);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.4s ease;
            z-index: 100;
            overflow-y: auto;
            transform-style: preserve-3d;
        }

        .panel.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        #about-panel {
            left: 60px;
            transform: perspective(1000px) translateY(-50%) translateX(-30px) rotateY(8deg);
        }

        #about-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 16px 0 0 16px;
        }

        #about-panel.visible {
            transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(8deg);
            animation: floatAbout 4s ease-in-out infinite;
            box-shadow: 25px 25px 50px rgba(0, 0, 0, 0.7);
        }

        #about-panel.visible:hover {
            animation: none;
            transform: perspective(1000px) translateY(calc(-50% - 3px)) translateX(0) rotateY(12deg) scale(1.02);
            box-shadow: 30px 30px 60px rgba(0, 0, 0, 0.8), -5px -5px 25px rgba(255, 255, 255, 0.08);
        }

        #community-panel {
            right: 40px;
            transform: perspective(1000px) translateY(-50%) translateX(30px) rotateY(-8deg);
        }

        #community-panel::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 0 16px 16px 0;
        }

        #community-panel.visible {
            transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(-8deg);
            animation: floatCommunity 4s ease-in-out infinite;
            box-shadow: 25px 25px 50px rgba(0, 0, 0, 0.7);
        }

        #community-panel.visible:hover {
            animation: none;
            transform: perspective(1000px) translateY(calc(-50% - 3px)) translateX(0) rotateY(-12deg) scale(1.02);
            box-shadow: -30px 30px 60px rgba(0, 0, 0, 0.8), 5px -5px 25px rgba(255, 255, 255, 0.08);
        }

        .panel-title {
            color: #ffffff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .panel-content {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.7;
        }

        .panel-content p { margin-bottom: 1rem; }

        .social-btn-panel {
            display: block;
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #ffffff;
            text-decoration: none;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .social-btn-panel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .contract-container { margin: 1.5rem 0; }
        .contract-label { color: #888; font-size: 0.9rem; margin-bottom: 0.5rem; }

        .contract-box {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 0.8rem;
            gap: 0.5rem;
        }

        #contract-address {
            flex: 1;
            color: #fff;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        #copy-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #copy-btn.copied { background: linear-gradient(135deg, #39ff14, #00ff88); }

        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .twitter-btn { background: linear-gradient(135deg, #1da1f2, #0d8bd9); color: #fff; }
        .buy-btn { background: linear-gradient(135deg, #39ff14, #00ff88); color: #000; }

        /* REMOVIDO - Laugh visualizer */
        #laugh-visualizer {
            display: none !important;
        }

        .viz-bar {
            width: 6px;
            height: 30px;
            background: linear-gradient(to top, #ff2d95, #ffea00);
            border-radius: 3px;
            animation: vizPulse 0.3s ease infinite alternate;
        }

        .viz-bar:nth-child(2) { animation-delay: 0.1s; }
        .viz-bar:nth-child(3) { animation-delay: 0.2s; }
        .viz-bar:nth-child(4) { animation-delay: 0.15s; }

        @keyframes vizPulse {
            from { transform: scaleY(0.3); }
            to { transform: scaleY(1); }
        }

        /* ===== LIVE CHAT (Firebase) - Minimalista ===== */
        #live-chat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 450px;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            font-family: 'Outfit', sans-serif;
            z-index: 1000;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        #live-chat.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #live-chat.minimized {
            height: auto;
        }

        /* Header do chat */
        #chat-header {
            background: transparent;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        #chat-title {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin: 0;
        }

        #chat-minimize {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        #chat-minimize:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Tela de entrada (username) */
        #chat-login {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 24px;
            text-align: center;
        }

        #chat-login.hidden {
            display: none;
        }

        #chat-login h3 {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        #username-input {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            margin-bottom: 16px;
        }

        #username-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #username-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        #enter-chat-btn {
            width: 100%;
            padding: 12px 24px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #enter-chat-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* √Årea de mensagens */
        #chat-main {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden; /* For√ßa o scroll interno no #chat-messages */
            min-height: 0; /* Necess√°rio para flex children com overflow */
        }

        #chat-main.active {
            display: flex;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0; /* Permite scroll correto */
        }

        #chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .message {
            padding: 8px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 3px;
        }

        .message-user {
            font-weight: 600;
            margin-right: 6px;
            /* Cor definida via inline style baseada no hash do username */
        }

        .message-text {
            color: rgba(255, 255, 255, 0.8);
            word-wrap: break-word;
        }

        /* Input de mensagem */
        #chat-input-area {
            padding: 12px;
            background: transparent;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            gap: 8px;
        }

        #message-input {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #ffffff;
            font-size: 13px;
            font-family: 'Outfit', sans-serif;
        }

        #message-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        #message-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        #send-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #send-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        #send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #send-btn:disabled:hover {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* ===== BOT√ÉO ENTER NA TELA DE LOADING ===== */
        #loading-enter-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 40px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-top: 2rem;
            opacity: 0;
            pointer-events: none;
        }

        #loading-enter-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #loading-enter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="curtains">
        <div class="curtain curtain-left"></div>
        <div class="curtain curtain-right"></div>
    </div>

    <div id="loading-overlay">
        <div id="loading-text">BENNY</div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-percent">0%</div>
        <button id="loading-enter-btn">ENTER</button>
    </div>

    <div id="ui-layer">
        <div id="joke-display">
            <div id="joke-text"></div>
        </div>

        <div id="nav-buttons">
            <button class="nav-btn" data-view="about">About</button>
            <button class="nav-btn active" data-view="home">Home</button>
            <button class="nav-btn" data-view="community">Community</button>
        </div>

        <div id="about-panel" class="panel">
            <h2 class="panel-title">About Benny</h2>
            <div class="panel-content">
                <p>Welcome to Benny's Stand-Up Comedy show. The funniest Bird in the crypto world bringing laughs to the blockchain.</p>
                <p>Benny is a digital performer combining cutting-edge 3D animation with blockchain technology, creating a unique entertainment experience in the metaverse.</p>
                <p>Built with Three.js and powered by Web3, Benny represents the future of digital entertainment and community engagement.</p>
            </div>
        </div>

        <div id="community-panel" class="panel">
            <h2 class="panel-title">Community</h2>
            <div class="panel-content">
                <p>Join the Benny community and be part of the revolution in digital entertainment.</p>

                <div style="margin: 24px 0;">
                    <a href="#" class="social-btn-panel" id="twitter-link" target="_blank" rel="noopener noreferrer">Twitter / X</a>
                    <a href="#" class="social-btn-panel" id="community-link" target="_blank" rel="noopener noreferrer">Community</a>
                    <a href="#" class="social-btn-panel" id="buy-link" target="_blank" rel="noopener noreferrer">Buy Token</a>
                </div>

                <div class="contract-container">
                    <div class="contract-label">Contract Address:</div>
                    <div class="contract-box" style="justify-content: center;">
                        <span id="contract-address" style="font-size: 1.5rem; font-weight: bold; color: #fff;">SOON</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="laugh-visualizer">
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <!-- Inicializar vari√°veis globais ANTES dos m√≥dulos (executa imediatamente) -->
    <script>
        // Error handler global para debug
        window.addEventListener('error', (e) => {
            console.error('üî• ERRO GLOBAL:', e.error || e.message);
            console.error('üìç Arquivo:', e.filename);
            console.error('üìç Linha:', e.lineno, ':', e.colno);

            // Mostrar erro na tela de loading
            const loadingPercent = document.getElementById('loading-percent');
            if (loadingPercent) {
                loadingPercent.innerHTML = `
                    <span style="color: #ff6b6b;">Erro: ${e.message}</span><br>
                    <small style="color: #aaa;">Verifique o console (F12)</small>
                `;
            }
        });

        // Declarar vari√°veis globais Firebase
        // IMPORTANTE: N√£o inicializar com valores default aqui para n√£o sobrescrever
        // valores setados pela IIFE do Firebase que roda depois
        if (typeof window.firebaseReady === 'undefined') {
            window.firebaseReady = false;
        }
        if (typeof window.currentJokeRef === 'undefined') {
            window.currentJokeRef = null;
        }

        // Vari√°vel de √°udio desbloqueado - NUNCA volta para false ap√≥s primeiro clique
        if (typeof window.isAudioUnlocked === 'undefined') {
            window.isAudioUnlocked = false;
        }

        console.log('‚úÖ Vari√°veis globais inicializadas');
    </script>

    <script type="module">
        console.log('üé¨ M√≥dulo iniciando...');

        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        console.log('‚úÖ Imports conclu√≠dos');
        console.log('üìç Three.js carregado:', typeof THREE !== 'undefined');

        const CONFIG = {
            // GLB hosted on Cloudflare R2 - No CORS issues, fast CDN delivery
            modelPath: 'https://pub-8d7b1a002dc7461881f41950b1c60105.r2.dev/mr_penguin.glb',
            contractAddress: '7UxJfQKSKvnXQPvMQDH9YPMEJg8z3ZrD4KwXmXXXpump',
            twitterUrl: 'https://x.com/BennyStandUp',
            communityUrl: 'https://x.com/i/communities/2016038721091445200',
            buyUrl: 'https://pump.fun/',

            rotations: {
                home: 0,
                about: 0.4,
                community: -0.4
            },

            jokes: [
                "Por que o pinguim n√£o sente frio? Porque ele nasceu no gelo! ü•∂",
                "Eu investi em cripto e agora moro num iglu... de luxo! üè†",
                "Qual √© o animal mais engra√ßado? O pinguim! Porque j√° nasce de smoking! ü§µ",
                "Minha carteira cripto √© t√£o fria quanto a Ant√°rtida... mas pelo menos eu tenho estilo! üòé",
                "Por que pinguins s√£o √≥timos traders? Porque sabem quando o mercado est√° congelado! üìâ"
            ],

            jokeDisplayTime: 5000,
            jokePauseTime: 1500
        };

        // ===== VARI√ÅVEIS GLOBAIS =====
        let scene, camera, renderer, mixer, model;
        let currentView = 'home';
        let currentAudioVolume = 1.0; // Volume baseado na aba (1.0 = HOME, 0.25 = ABOUT/COMMUNITY)
        let currentJokeAudio = null; // Refer√™ncia ao √°udio atual para ajustar volume em tempo real
        let audioContext, laughBuffer;
        let jokeInterval;
        let currentJokeIndex = 0;
        // REMOVIDO: isAudioUnlocked - agora √© window.isAudioUnlocked (global)
        // REMOVIDO: window.firebaseReady e window.shouldAutoStart - agora inicializados em script inline antes do m√≥dulo

        // C√¢meras do GLB
        let glbCameras = {};
        let targetCameraPosition = new THREE.Vector3();
        let targetCameraQuaternion = new THREE.Quaternion();
        
        // Velocidade da anima√ß√£o (1.0 = normal, 0.5 = metade, 2.0 = dobro)
        const ANIMATION_SPEED = 2.5; // BEM mais r√°pido

        // ===== ELEMENTOS DOM =====
        const curtains = document.getElementById('curtains');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingBar = document.getElementById('loading-bar');
        const loadingPercent = document.getElementById('loading-percent');
        const loadingEnterBtn = document.getElementById('loading-enter-btn');
        const jokeDisplay = document.getElementById('joke-display');
        const jokeText = document.getElementById('joke-text');
        const navButtons = document.querySelectorAll('.nav-btn');
        const aboutPanel = document.getElementById('about-panel');
        const communityPanel = document.getElementById('community-panel');
        const liveChat = document.getElementById('live-chat');
        const laughVisualizer = document.getElementById('laugh-visualizer');
        const contractAddressEl = document.getElementById('contract-address');
        const copyBtn = document.getElementById('copy-btn');
        const twitterLink = document.getElementById('twitter-link');
        const communityLink = document.getElementById('community-link');
        const buyLink = document.getElementById('buy-link');

        // ===== INICIALIZA√á√ÉO =====
        function init() {
            console.log('üéÆ Fun√ß√£o init() chamada');
            console.log('üì¶ CONFIG:', CONFIG);

            // contractAddress agora √© est√°tico ("SOON") no HTML
            twitterLink.href = CONFIG.twitterUrl;
            communityLink.href = CONFIG.communityUrl;
            buyLink.href = CONFIG.buyUrl;

            // Cria cena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Cria c√¢mera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);

            // ===== RENDERER - QUALIDADE E REALISMO =====
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance",
                alpha: false,
                stencil: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // Cor e tone mapping realista
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 0.7; // Mais escuro para manter efeito de spotlight
            
            // Sombras de alta qualidade
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.shadowMap.autoUpdate = true;
            
            // F√≠sica de luz realista
            renderer.useLegacyLights = false;
            
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            loadModel();
            setupAudio();
            setupEventListeners();
            window.addEventListener('resize', onWindowResize);
            animate();

            // Keep-alive para AudioContext - garante que nunca volta para suspended
            setInterval(() => {
                if (audioContext && audioContext.state === 'suspended') {
                    console.log('‚ö†Ô∏è AudioContext suspended! Resumindo automaticamente...');
                    audioContext.resume().then(() => {
                        window.isAudioUnlocked = true;
                        console.log('‚úÖ AudioContext resumed pelo keep-alive');
                    }).catch(err => {
                        console.error('‚ùå Erro no keep-alive do AudioContext:', err);
                    });
                }
            }, 2000); // Verifica a cada 2 segundos
        }

        // ===== CARREGAMENTO DO MODELO =====
        function loadModel() {
            console.log('üîÑ Iniciando carregamento do modelo...');
            console.log('üì¶ Caminho:', CONFIG.modelPath);

            const loader = new GLTFLoader();

            // Fallback: se n√£o houver progresso em 2s, mostrar loading gen√©rico
            let progressReceived = false;
            const fallbackTimer = setTimeout(() => {
                if (!progressReceived) {
                    console.log('‚ö†Ô∏è Sem informa√ß√£o de progresso. Usando fallback...');
                    loadingPercent.textContent = 'Carregando modelo...';

                    // Anima√ß√£o fake de progresso
                    let fakeProgress = 0;
                    const fakeInterval = setInterval(() => {
                        fakeProgress += 5;
                        if (fakeProgress <= 90) {
                            loadingBar.style.width = fakeProgress + '%';
                            loadingPercent.textContent = fakeProgress + '%';
                        }
                    }, 500);

                    // Limpar quando carregar
                    window.fakeFallbackInterval = fakeInterval;
                }
            }, 2000);

            loader.load(
                CONFIG.modelPath + '?t=' + Date.now(), // Evita cache
                (gltf) => {
                    clearTimeout(fallbackTimer);
                    if (window.fakeFallbackInterval) {
                        clearInterval(window.fakeFallbackInterval);
                    }

                    console.log('‚úÖ GLB carregado!');

                    // For√ßar 100%
                    loadingBar.style.width = '100%';
                    loadingPercent.textContent = '100%';

                    model = gltf.scene;
                    scene.add(model);

                    // ===== C√ÇMERAS DO GLB =====
                    if (gltf.cameras && gltf.cameras.length > 0) {
                        console.log('üì∑ C√¢meras encontradas:', gltf.cameras.length);
                        
                        // Percorre a cena para encontrar as c√¢meras com suas posi√ß√µes
                        gltf.scene.traverse((child) => {
                            if (child.isCamera) {
                                const camName = child.name.toLowerCase();
                                glbCameras[camName] = {
                                    position: child.position.clone(),
                                    quaternion: child.quaternion.clone(),
                                    fov: child.fov || 50
                                };
                                console.log('üì∑ C√¢mera salva:', child.name);
                            }
                        });
                        
                        // Se n√£o encontrou nas traversals, usa as c√¢meras do array
                        if (Object.keys(glbCameras).length === 0) {
                            gltf.cameras.forEach((cam, index) => {
                                const camName = cam.name ? cam.name.toLowerCase() : `camera_${index}`;
                                glbCameras[camName] = {
                                    position: cam.position.clone(),
                                    quaternion: cam.quaternion.clone(),
                                    fov: cam.fov || 50
                                };
                                console.log('üì∑ C√¢mera salva (array):', camName);
                            });
                        }
                        
                        // Define c√¢mera inicial (home ou primeira dispon√≠vel)
                        const homeCamera = glbCameras['home'] || glbCameras['camera'] || Object.values(glbCameras)[0];
                        if (homeCamera) {
                            camera.position.copy(homeCamera.position);
                            camera.quaternion.copy(homeCamera.quaternion);
                            camera.fov = homeCamera.fov;
                            camera.updateProjectionMatrix();
                            
                            targetCameraPosition.copy(homeCamera.position);
                            targetCameraQuaternion.copy(homeCamera.quaternion);
                        }
                        
                        console.log('‚úÖ C√¢meras configuradas!');
                        console.log('üì∑ C√¢meras dispon√≠veis:', Object.keys(glbCameras));
                    } else {
                        camera.position.set(0, 2, 6);
                        camera.lookAt(0, 1.2, 0);
                        targetCameraPosition.copy(camera.position);
                        targetCameraQuaternion.copy(camera.quaternion);
                        console.log('‚ö†Ô∏è Nenhuma c√¢mera no GLB, usando padr√£o');
                    }

                    // ===== LUZES DO GLB - USANDO SOMENTE AS DO BLENDER =====
                    let hasLights = false;
                    gltf.scene.traverse((child) => {
                        if (child.isLight) {
                            hasLights = true;
                            
                            const lightName = child.name.toLowerCase();
                            
                            // Luz PRINCIPAL (foco no personagem) - mais forte
                            if (lightName.includes('principal') || lightName.includes('main') || lightName.includes('key')) {
                                child.intensity = child.intensity * 0.001; // Mais forte
                                console.log('üí° LUZ PRINCIPAL:', child.name, '- Intensidade:', child.intensity.toFixed(2));
                            } else {
                                // Outras luzes - mant√©m mais fracas
                                child.intensity = child.intensity * 0.0005;
                                console.log('üí° Luz secund√°ria:', child.name, '- Intensidade:', child.intensity.toFixed(2));
                            }
                            
                            // Sombras de alta qualidade
                            child.castShadow = true;
                            
                            if (child.isSpotLight) {
                                child.penumbra = 0.5;
                                child.decay = 2;
                                
                                child.shadow.mapSize.width = 2048;
                                child.shadow.mapSize.height = 2048;
                                child.shadow.camera.near = 0.1;
                                child.shadow.camera.far = 50;
                                child.shadow.bias = -0.0001;
                                child.shadow.normalBias = 0.02;
                                child.shadow.radius = 4;
                            }
                            
                            if (child.isPointLight) {
                                child.decay = 2;
                                child.shadow.mapSize.width = 1024;
                                child.shadow.mapSize.height = 1024;
                                child.shadow.bias = -0.0001;
                                child.shadow.radius = 3;
                            }
                        }
                    });

                    console.log('üí° Usando SOMENTE as luzes do GLB!');

                    // SEM luz ambiente extra - apenas as luzes do GLB

                    // Se n√£o tiver luzes no GLB, adiciona luzes b√°sicas realistas
                    if (!hasLights) {
                        const keyLight = new THREE.SpotLight(0xffffff, 50);
                        keyLight.position.set(5, 10, 5);
                        keyLight.castShadow = true;
                        keyLight.shadow.mapSize.width = 2048;
                        keyLight.shadow.mapSize.height = 2048;
                        keyLight.shadow.bias = -0.0001;
                        keyLight.penumbra = 0.5;
                        scene.add(keyLight);
                        
                        const fillLight = new THREE.DirectionalLight(0x8888ff, 0.3);
                        fillLight.position.set(-5, 5, -5);
                        scene.add(fillLight);
                    }

                    // ===== MATERIAIS - CONFIGURA√á√ÉO REALISTA =====
                    model.traverse((child) => {
                        if (child.isMesh) {
                            // Sombras
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            if (child.material) {
                                const materials = Array.isArray(child.material) ? child.material : [child.material];
                                materials.forEach(mat => {
                                    // Configura texturas com colorSpace correto
                                    if (mat.map) {
                                        mat.map.colorSpace = THREE.SRGBColorSpace;
                                        mat.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                                    }
                                    if (mat.emissiveMap) {
                                        mat.emissiveMap.colorSpace = THREE.SRGBColorSpace;
                                    }
                                    
                                    // Configura√ß√µes PBR realistas
                                    if (mat.isMeshStandardMaterial || mat.isMeshPhysicalMaterial) {
                                        mat.envMapIntensity = 0.5;
                                    }
                                    
                                    mat.needsUpdate = true;
                                });
                            }
                        }
                    });
                    
                    console.log('‚úÖ Materiais configurados');

                    // ===== CORRE√á√ÉO DE NORMAIS PARA TODO O CEN√ÅRIO (EXCETO PERSONAGEM) =====
                    model.traverse((child) => {
                        if (child.isMesh) {
                            const name = child.name.toLowerCase();
                            
                            // Lista de nomes que identificam o PERSONAGEM (n√£o aplicar corre√ß√£o)
                            const isCharacter = 
                                name.includes('penguin') || 
                                name.includes('personagem') ||
                                name.includes('character') ||
                                name.includes('sketchfab') ||
                                name.includes('mr_penguin') ||
                                name.includes('tripo') ||
                                name.includes('body') ||
                                name.includes('head') ||
                                name.includes('arm') ||
                                name.includes('leg') ||
                                name.includes('hand') ||
                                name.includes('foot') ||
                                name.includes('mesh_0') ||
                                (child.parent && child.parent.name.toLowerCase().includes('armature'));
                            
                            // Se N√ÉO for personagem, aplica corre√ß√£o de normais apenas
                            if (!isCharacter) {
                                // Recalcula normais da geometria para suavizar
                                child.geometry.computeVertexNormals();
                                
                                if (child.material) {
                                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                                    materials.forEach(mat => {
                                        // Remove normal/bump map que podem causar artefatos
                                        if (mat.normalMap) mat.normalMap = null;
                                        if (mat.bumpMap) mat.bumpMap = null;
                                        
                                        // For√ßa smooth shading
                                        mat.flatShading = false;
                                        
                                        mat.needsUpdate = true;
                                    });
                                }
                            }
                        }
                    });
                    
                    console.log('‚úÖ Normais do cen√°rio corrigidas');

                    // ===== ANIMA√á√ïES - TOCAR COMPLETA EM LOOP =====
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        
                        // Configura velocidade da anima√ß√£o
                        mixer.timeScale = ANIMATION_SPEED;
                        
                        gltf.animations.forEach((clip) => {
                            console.log('üé¨ Anima√ß√£o encontrada:', clip.name, '- Dura√ß√£o:', clip.duration.toFixed(2) + 's', '- Tracks:', clip.tracks.length);
                            
                            // IGNORA anima√ß√µes muito curtas (menos de 15 segundos)
                            // A "Armature" de 8.63s est√° cortada, ignoramos ela
                            if (clip.duration < 15) {
                                console.log('‚è≠Ô∏è Ignorando anima√ß√£o curta:', clip.name);
                                return; // Pula para pr√≥xima
                            }
                            
                            const action = mixer.clipAction(clip);
                            
                            // Garante que toca em LOOP infinito
                            action.setLoop(THREE.LoopRepeat, Infinity);
                            
                            // Come√ßa do in√≠cio
                            action.reset();
                            
                            // Peso total (100% da anima√ß√£o)
                            action.setEffectiveWeight(1);
                            
                            // Tempo total (n√£o corta)
                            action.setEffectiveTimeScale(1);
                            
                            // N√£o para no final
                            action.clampWhenFinished = false;
                            
                            // Inicia a anima√ß√£o
                            action.play();
                            
                            console.log('‚úÖ Anima√ß√£o ativada:', clip.name);
                        });
                        
                        console.log('‚úÖ Anima√ß√µes iniciadas (velocidade:', ANIMATION_SPEED + 'x)');
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma anima√ß√£o encontrada no GLB!');
                    }

                    // Mostrar bot√£o ENTER
                    setTimeout(() => {
                        loadingEnterBtn.classList.add('visible');
                        console.log('‚úÖ Bot√£o ENTER vis√≠vel');
                    }, 500);

                    openCurtains();
                },
                (xhr) => {
                    progressReceived = true;

                    if (xhr.lengthComputable && xhr.total > 0) {
                        const percent = Math.round((xhr.loaded / xhr.total) * 100);
                        loadingBar.style.width = percent + '%';
                        loadingPercent.textContent = percent + '%';
                        console.log(`üìä Progresso: ${percent}% (${xhr.loaded}/${xhr.total})`);
                    } else {
                        // Se n√£o tem tamanho total, mostrar apenas bytes carregados
                        const mb = (xhr.loaded / 1024 / 1024).toFixed(2);
                        loadingPercent.textContent = `${mb} MB`;
                        console.log(`üìä Carregado: ${mb} MB`);
                    }
                },
                (error) => {
                    clearTimeout(fallbackTimer);
                    if (window.fakeFallbackInterval) {
                        clearInterval(window.fakeFallbackInterval);
                    }

                    console.error('‚ùå ERRO ao carregar modelo:', error);
                    console.error('üìã Detalhes:', {
                        message: error.message,
                        type: error.type,
                        target: error.target
                    });

                    loadingPercent.textContent = 'Erro ao carregar';
                    loadingBar.style.width = '0%';
                    loadingBar.style.background = 'linear-gradient(90deg, #ff0000, #ff6b6b)';

                    // Mostrar mensagem de erro mais amig√°vel
                    setTimeout(() => {
                        loadingPercent.innerHTML = 'Erro ao carregar modelo 3D<br><small>Verifique sua conex√£o</small>';
                    }, 1000);
                }
            );
        }

        function openCurtains() {
            // N√ÉO esconde o loading overlay automaticamente
            // Apenas prepara as cortinas para abrir quando clicar em ENTER
            console.log('‚úÖ Modelo carregado. Aguardando clique em ENTER...');
        }

        // ===== √ÅUDIO =====
        function setupAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                generateLaughSound();
            } catch (e) {}
        }

        function unlockAudio() {
            console.log('üîì unlockAudio() chamada');
            console.log('üìä Estado:', {
                'window.isAudioUnlocked': window.isAudioUnlocked,
                hasAudioContext: !!audioContext,
                audioContextState: audioContext?.state,
                jokeLoopEnabled
            });

            // SEMPRE tentar resumir AudioContext se estiver suspended
            if (audioContext && audioContext.state === 'suspended') {
                console.log('‚ñ∂Ô∏è Resumindo AudioContext...');
                audioContext.resume().then(() => {
                    // Uma vez desbloqueado, NUNCA volta para false
                    window.isAudioUnlocked = true;
                    console.log('‚úÖ AudioContext resumed! window.isAudioUnlocked =', window.isAudioUnlocked);
                }).catch(err => {
                    console.error('‚ùå Erro ao resumir AudioContext:', err);
                });
            } else if (audioContext && audioContext.state === 'running') {
                console.log('‚ÑπÔ∏è AudioContext j√° est√° running');
                window.isAudioUnlocked = true;
            } else {
                console.log('‚ÑπÔ∏è AudioContext n√£o existe ainda');
            }
        }

        function generateLaughSound() {
            if (!audioContext) return;
            const sampleRate = audioContext.sampleRate;
            const duration = 1.5;
            const bufferSize = sampleRate * duration;
            laughBuffer = audioContext.createBuffer(1, bufferSize, sampleRate);
            const data = laughBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                const t = i / sampleRate;
                const env = Math.exp(-t * 2) * 0.3;
                data[i] = (Math.random() * 2 - 1) * env + Math.sin(Math.PI * 200 * t) * env * 0.5;
            }
        }

        // ===== SISTEMA DE PIADAS COM BUFFER (0 DELAY) =====
        window.jokeBuffer = [];  // Buffer de piadas pr√©-carregadas
        window.isGenerating = false;  // Flag para evitar gerar m√∫ltiplas vezes
        window.jokeLoopEnabled = false;  // Expor globalmente para listener Firebase
        let isPlayingJoke = false;

        // ===== SISTEMA DE RISADAS =====
        const laughByRating = {
            1: ['/audio/laugh1.mp3', '/audio/laugh4.mp3'],  // leves
            2: ['/audio/laugh2.mp3'],                        // forte
            3: ['/audio/laugh3.mp3']                         // m√©dia
        };

        function selectLaughByRating(rating) {
            const options = laughByRating[rating] || laughByRating[3];
            return options[Math.floor(Math.random() * options.length)];
        }

        function playLaugh(rating) {
            return new Promise((resolve) => {
                const laughPath = selectLaughByRating(rating);
                console.log(`üòÇ Tocando risada (rating ${rating}): ${laughPath}`);

                const laughAudio = new Audio(laughPath);
                laughAudio.volume = currentAudioVolume * 0.6; // 60% do volume atual

                laughAudio.onended = () => {
                    console.log('‚úÖ Risada finalizada');
                    resolve();
                };

                laughAudio.onerror = (e) => {
                    console.error('‚ùå Erro ao tocar risada:', e);
                    resolve(); // Continua mesmo se falhar
                };

                laughAudio.play().catch(err => {
                    console.error('‚ùå Erro ao play risada:', err);
                    resolve(); // Continua mesmo se falhar
                });
            });
        }

        // Gerar piada e adicionar ao buffer (n√£o bloqueia)
        async function generateJokeToBuffer() {
            if (window.isGenerating) {
                console.log('‚ö†Ô∏è J√° est√° gerando uma piada, aguardando...');
                return;
            }

            window.isGenerating = true;
            console.log('üé¨ Gerando piada para o buffer...');

            try {
                const response = await fetch('/api/generate-joke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success || !data.audio || !data.joke) {
                    throw new Error(data.message || 'Invalid joke data');
                }

                // Adicionar ao buffer (com rating)
                const jokeData = {
                    id: Date.now(),
                    text: data.joke,
                    audio: data.audio,
                    audioFormat: data.audioFormat || 'audio/mpeg',
                    rating: data.rating || 3,  // 1 = leve, 2 = forte, 3 = m√©dia
                    createdAt: Date.now()
                };

                window.jokeBuffer.push(jokeData);
                console.log(`‚úÖ Piada adicionada ao buffer! Total: ${window.jokeBuffer.length}, Rating: ${jokeData.rating}`);

            } catch (error) {
                console.error('‚ùå Erro ao gerar piada:', error);
            } finally {
                window.isGenerating = false;
            }
        }

        // Pr√©-carregar buffer inicial (2 piadas)
        async function preloadJokes() {
            console.log('üì¶ Pr√©-carregando buffer de piadas...');

            const promises = [];
            for (let i = 0; i < 2; i++) {
                promises.push(generateJokeToBuffer());
            }

            await Promise.all(promises);

            console.log(`‚úÖ Buffer pr√©-carregado! ${window.jokeBuffer.length} piadas prontas`);
        }

        // Tocar pr√≥xima piada do buffer (INSTANT√ÇNEO - 0 delay)
        async function playNextJoke() {
            console.log('üéµ playNextJoke() chamada');

            // Se buffer vazio, gerar uma piada
            if (window.jokeBuffer.length === 0) {
                console.log('‚ö†Ô∏è Buffer vazio! Gerando piada...');
                await generateJokeToBuffer();
            }

            // Se ainda est√° vazio (erro na gera√ß√£o), abortar
            if (window.jokeBuffer.length === 0) {
                console.error('‚ùå N√£o foi poss√≠vel gerar piada. Tentando novamente em 5s...');
                setTimeout(playNextJoke, 5000);
                return;
            }

            // Pegar primeira piada do buffer (INSTANT√ÇNEO!)
            const jokeData = window.jokeBuffer.shift();
            console.log(`üé§ BENNY: "${jokeData.text}"`);
            console.log(`‚≠ê Rating: ${jokeData.rating}`);
            console.log(`üìä Buffer restante: ${window.jokeBuffer.length} piadas`);

            isPlayingJoke = true;

            try {
                // Converter base64 para √°udio
                const audioData = atob(jokeData.audio);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }

                const audioBlob = new Blob([audioArray], { type: jokeData.audioFormat || 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);

                // Criar elemento de √°udio
                const audio = new Audio(audioUrl);
                audio.volume = currentAudioVolume;
                currentJokeAudio = audio;

                // Quando a piada terminar
                audio.addEventListener('ended', async () => {
                    console.log('‚úÖ Piada finalizada!');
                    URL.revokeObjectURL(audioUrl);
                    currentJokeAudio = null;

                    // Broadcast no Firebase para sincronizar outros clientes
                    if (window.currentJokeRef) {
                        window.currentJokeRef.set({
                            id: jokeData.id,
                            text: jokeData.text,
                            audio: jokeData.audio,
                            audioFormat: jokeData.audioFormat,
                            rating: jokeData.rating,
                            startedAt: Date.now()
                        }).catch(err => console.error('Erro ao sincronizar Firebase:', err));
                    }

                    // Tocar risada baseada no rating (IMEDIATO)
                    await playLaugh(jokeData.rating);

                    isPlayingJoke = false;

                    // PR√ìXIMA PIADA IMEDIATAMENTE ap√≥s risada (0 delay!)
                    if (window.jokeLoopEnabled) {
                        playNextJoke();
                    }
                });

                // Erro no √°udio
                audio.addEventListener('error', (e) => {
                    console.error('‚ùå Erro ao tocar √°udio:', e);
                    URL.revokeObjectURL(audioUrl);
                    currentJokeAudio = null;
                    isPlayingJoke = false;

                    // Tentar pr√≥xima piada
                    if (window.jokeLoopEnabled) {
                        setTimeout(playNextJoke, 2000);
                    }
                });

                // Garantir que AudioContext est√° ativo
                if (audioContext && audioContext.state === 'suspended') {
                    await audioContext.resume();
                    window.isAudioUnlocked = true;
                }

                // Tocar √°udio
                await audio.play();
                console.log('üéâ √ÅUDIO TOCANDO!');

                // Repor o buffer em background (n√£o bloqueia)
                if (window.jokeBuffer.length < 2) {
                    console.log('üîÑ Reabastecendo buffer...');
                    generateJokeToBuffer(); // Async, n√£o bloqueia
                }

            } catch (error) {
                console.error('‚ùå Erro ao tocar piada:', error);
                isPlayingJoke = false;

                // Tentar pr√≥xima em 2s
                if (window.jokeLoopEnabled) {
                    setTimeout(playNextJoke, 2000);
                }
            }
        }

        // ===== INICIALIZAR BENNY (show ao vivo) =====
        async function initializeBenny() {
            console.log('üé¨ initializeBenny() CHAMADA!');

            if (window.jokeLoopEnabled) {
                console.log('‚ö†Ô∏è Benny j√° est√° ativo!');
                return;
            }

            console.log('‚úÖ Iniciando show ao vivo...');
            window.jokeLoopEnabled = true;

            // Pr√©-carregar buffer de piadas
            await preloadJokes();

            // Come√ßar a tocar (INSTANT√ÇNEO!)
            console.log('üé≠ Iniciando primeira piada...');
            playNextJoke();
        }

        // Expor controles no console para desenvolvimento
        window.initializeBenny = initializeBenny;
        window.startBenny = initializeBenny;
        window.stopBenny = function() {
            window.jokeLoopEnabled = false;
            console.log('‚è∏Ô∏è Show pausado.');
        };

        // ===== PIADAS (DESATIVADO) =====
        /*
        function startJokeLoop() {
            showJoke();
            jokeInterval = setInterval(() => {
                hideJoke();
                setTimeout(() => {
                    currentJokeIndex = (currentJokeIndex + 1) % CONFIG.jokes.length;
                    showJoke();
                }, CONFIG.jokePauseTime);
            }, CONFIG.jokeDisplayTime + CONFIG.jokePauseTime);
        }

        function showJoke() {
            if (currentView !== 'home') return;
            jokeText.textContent = CONFIG.jokes[currentJokeIndex];
            jokeDisplay.classList.add('visible');
            setTimeout(() => playLaugh(), 2000);
        }

        function hideJoke() {
            jokeDisplay.classList.remove('visible');
        }

        function stopJokeLoop() {
            if (jokeInterval) {
                clearInterval(jokeInterval);
                jokeInterval = null;
            }
            hideJoke();
        }
        */

        // ===== AJUSTE DE VOLUME BASEADO NA ABA =====
        function smoothVolumeTransition(targetVolume, duration = 500) {
            const startVolume = currentAudioVolume;
            const startTime = Date.now();

            function updateVolume() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1.0);

                // Interpola√ß√£o linear do volume
                currentAudioVolume = startVolume + (targetVolume - startVolume) * progress;

                // Aplica ao √°udio atual se estiver tocando
                if (currentJokeAudio) {
                    currentJokeAudio.volume = currentAudioVolume;
                }

                // Continua a transi√ß√£o se n√£o terminou
                if (progress < 1.0) {
                    requestAnimationFrame(updateVolume);
                }
            }

            updateVolume();
        }

        // ===== NAVEGA√á√ÉO =====
        function changeView(view) {
            if (view === currentView) return;
            currentView = view;

            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            aboutPanel.classList.remove('visible');
            communityPanel.classList.remove('visible');
            liveChat.classList.remove('visible');

            // ===== AJUSTE DE VOLUME BASEADO NA ABA =====
            // HOME: volume alto (100%) - som pr√≥ximo
            // ABOUT/COMMUNITY: volume baixo (25%) - som ao longe
            const targetVolume = view === 'home' ? 1.0 : 0.25;
            smoothVolumeTransition(targetVolume, 500);

            // ===== TROCA DE C√ÇMERA BASEADO NA VIEW =====
            // Procura c√¢mera pelo nome (about, community, home)
            let targetCamera = null;
            
            // Tenta encontrar c√¢mera com nome exato ou similar
            const possibleNames = [
                view,
                view + '_camera',
                'camera_' + view,
                'cam_' + view
            ];
            
            for (const name of possibleNames) {
                if (glbCameras[name]) {
                    targetCamera = glbCameras[name];
                    console.log('üì∑ Trocando para c√¢mera:', name);
                    break;
                }
            }
            
            // Se n√£o encontrou, usa a c√¢mera home ou a primeira dispon√≠vel
            if (!targetCamera) {
                targetCamera = glbCameras['home'] || glbCameras['camera'] || Object.values(glbCameras)[0];
                console.log('üì∑ C√¢mera n√£o encontrada para', view, '- usando padr√£o');
            }
            
            // Define posi√ß√£o/rota√ß√£o alvo para transi√ß√£o suave
            if (targetCamera) {
                targetCameraPosition.copy(targetCamera.position);
                targetCameraQuaternion.copy(targetCamera.quaternion);
                
                // Atualiza FOV se diferente
                if (camera.fov !== targetCamera.fov) {
                    camera.fov = targetCamera.fov;
                    camera.updateProjectionMatrix();
                }
            }

            // Sistema de piadas continua rodando independente da view
            // (usu√°rio controla via startBenny/stopBenny no console)

            if (view === 'about') {
                setTimeout(() => aboutPanel.classList.add('visible'), 500);
            } else if (view === 'community') {
                setTimeout(() => communityPanel.classList.add('visible'), 500);
            } else if (view === 'home') {
                setTimeout(() => liveChat.classList.add('visible'), 500);
            }
        }

        // ===== EVENTOS =====
        function setupEventListeners() {
            // BOT√ÉO ENTER - Abre cortinas e desbloqueia √°udio (N√ÉO inicia piadas ainda)
            loadingEnterBtn.addEventListener('click', () => {
                console.log('üé¨ ENTER clicado! Abrindo cortinas...');

                // Esconde tela de loading
                loadingOverlay.classList.add('hidden');

                // Abre cortinas
                setTimeout(() => {
                    curtains.classList.add('open');

                    // Mostra o chat junto com os bot√µes
                    setTimeout(() => {
                        liveChat.classList.add('visible');
                    }, 500);
                }, 300);

                // Desbloqueia √°udio
                unlockAudio();

                // N√ÉO inicia Benny ainda - aguarda comando "LAN√áAMENTO"
                console.log('‚è∏Ô∏è Aguardando comando "LAN√áAMENTO" para iniciar as piadas...');
            });

            // Desbloquear √°udio no primeiro clique do usu√°rio (backup)
            document.addEventListener('click', () => {
                console.log('üëÜ Primeiro clique detectado! Desbloqueando √°udio...');
                unlockAudio();
            }, { once: true });

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => changeView(btn.dataset.view));
            });

            // copyBtn removido - contract address agora √© "SOON" est√°tico

            document.addEventListener('keydown', (e) => {
                // N√£o bloquear teclas se o usu√°rio estiver digitando em um input
                const isTyping = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

                if (e.key === 'ArrowLeft' && !isTyping) changeView('about');
                else if (e.key === 'ArrowRight' && !isTyping) changeView('community');
                else if ((e.key === 'Escape' || e.key === ' ') && !isTyping) {
                    changeView('home');
                    e.preventDefault();
                }
            });
        }

        // ===== LOOP DE ANIMA√á√ÉO =====
        const clock = new THREE.Clock();
        const CAMERA_LERP_SPEED = 0.03; // Velocidade da transi√ß√£o de c√¢mera (0.01 = lento, 0.1 = r√°pido)

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);

            // Transi√ß√£o suave da posi√ß√£o da c√¢mera
            camera.position.lerp(targetCameraPosition, CAMERA_LERP_SPEED);
            
            // Transi√ß√£o suave da rota√ß√£o da c√¢mera
            camera.quaternion.slerp(targetCameraQuaternion, CAMERA_LERP_SPEED);

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>

    <!-- ===== LIVE CHAT COM FIREBASE ===== -->
    <div id="live-chat">
        <!-- Header -->
        <div id="chat-header">
            <h3 id="chat-title">üí¨ Live Chat</h3>
            <button id="chat-minimize">‚àí</button>
        </div>

        <!-- Tela de Login (Username) -->
        <div id="chat-login">
            <h3>Live Chat</h3>
            <input
                type="text"
                id="username-input"
                placeholder="Enter your nickname..."
                maxlength="20"
            />
            <button id="enter-chat-btn">JOIN</button>
        </div>

        <!-- Tela Principal do Chat -->
        <div id="chat-main">
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Type your message..."
                    maxlength="300"
                />
                <button id="send-btn">SEND</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ===== FIREBASE LIVE CHAT SYSTEM =====
        (function() {
            // CONFIGURA√á√ÉO FIREBASE (substituir pelas suas credenciais)
            const firebaseConfig = {
                apiKey: "AIzaSyBNvWHjauKLjR7Dxv0EgC29Y9VzGmRLV3M",
                authDomain: "standup-b42e6.firebaseapp.com",
                databaseURL: "https://standup-b42e6-default-rtdb.firebaseio.com",
                projectId: "standup-b42e6",
                storageBucket: "standup-b42e6.firebasestorage.app",
                messagingSenderId: "760517951974",
                appId: "1:760517951974:web:9ccde89c735dc1c8659627"
            };

            // Inicializar Firebase
            let database;
            let messagesRef;

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                messagesRef = database.ref('chat/messages');

                // Inicializar refer√™ncia para piadas sincronizadas (usar window para acesso global)
                window.currentJokeRef = database.ref('currentJoke');

                // Listener para comando de LAN√áAMENTO
                const launchRef = database.ref('liveShow/isLaunched');
                launchRef.on('value', (snapshot) => {
                    const isLaunched = snapshot.val();

                    if (isLaunched === true && !window.jokeLoopEnabled) {
                        console.log('üöÄ LAN√áAMENTO DETECTADO! Iniciando show...');

                        // Aguardar 2s para garantir que √°udio est√° desbloqueado
                        setTimeout(() => {
                            if (window.initializeBenny) {
                                window.initializeBenny();
                            }
                        }, 2000);
                    }
                });

                // Marcar Firebase como pronto (usar window para acesso global)
                window.firebaseReady = true;
                console.log('‚úÖ Firebase inicializado com sucesso (Chat + Jokes Sync)');
                console.log('üî• window.firebaseReady =', window.firebaseReady);
                console.log('üî• window.currentJokeRef =', window.currentJokeRef);
                console.log('‚è∏Ô∏è Aguardando comando LAN√áAMENTO...');
            } catch (error) {
                console.error('‚ùå ERRO AO INICIALIZAR FIREBASE:', error);
                console.error('üìã Detalhes do erro:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                window.firebaseReady = false;
                console.error('üî• window.firebaseReady RESETADO PARA:', window.firebaseReady);
            }

            // Elementos DOM
            const chatLogin = document.getElementById('chat-login');
            const chatMain = document.getElementById('chat-main');
            const usernameInput = document.getElementById('username-input');
            const enterChatBtn = document.getElementById('enter-chat-btn');
            const chatMessages = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const chatMinimize = document.getElementById('chat-minimize');
            const liveChat = document.getElementById('live-chat');

            let currentUsername = null;

            // Verificar se j√° tem username salvo
            const savedUsername = localStorage.getItem('chat_username');
            if (savedUsername) {
                enterChat(savedUsername);
            }

            // Entrar no chat
            enterChatBtn.addEventListener('click', () => {
                const username = usernameInput.value.trim();
                if (!username) {
                    alert('Por favor, digite um username');
                    return;
                }
                if (username.length > 20) {
                    alert('Username muito longo (m√°x 20 caracteres)');
                    return;
                }
                enterChat(username);
            });

            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enterChatBtn.click();
            });

            function enterChat(username) {
                currentUsername = username;
                localStorage.setItem('chat_username', username);
                chatLogin.classList.add('hidden');
                chatMain.classList.add('active');

                // Carregar mensagens e escutar mudan√ßas
                loadMessages();
            }

            // Carregar mensagens do Firebase
            function loadMessages() {
                if (!messagesRef) {
                    console.error('Firebase n√£o inicializado');
                    return;
                }

                // Buscar √∫ltimas 50 mensagens
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    chatMessages.innerHTML = '';

                    if (!snapshot.exists()) {
                        chatMessages.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px 20px; font-size: 13px;">Be the first to send a message!</div>';
                        return;
                    }

                    snapshot.forEach((childSnapshot) => {
                        const msg = childSnapshot.val();
                        renderMessage(msg);
                    });

                    // Auto-scroll para o final
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }

            // Gera cor √∫nica e consistente baseada no username
            function getUserColor(username) {
                let hash = 0;
                for (let i = 0; i < username.length; i++) {
                    hash = username.charCodeAt(i) + ((hash << 5) - hash);
                }
                const colors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                    '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                    '#BB8FCE', '#85C1E9', '#F8B739', '#E74C3C',
                    '#3498DB', '#2ECC71', '#9B59B6', '#1ABC9C'
                ];
                return colors[Math.abs(hash) % colors.length];
            }

            // Renderizar uma mensagem
            function renderMessage(msg) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';

                const time = new Date(msg.timestamp).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const userColor = getUserColor(msg.username);

                messageEl.innerHTML = `
                    <div class="message-time">${time}</div>
                    <span class="message-user" style="color: ${userColor};">${escapeHtml(msg.username)}:</span>
                    <span class="message-text">${escapeHtml(msg.text)}</span>
                `;

                chatMessages.appendChild(messageEl);
            }

            // Enviar mensagem
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            function sendMessage() {
                const text = messageInput.value.trim();
                if (!text || !currentUsername) return;

                if (!messagesRef) {
                    alert('Firebase n√£o est√° configurado. Adicione suas credenciais.');
                    return;
                }

                const message = {
                    username: currentUsername,
                    text: text,
                    timestamp: Date.now()
                };

                messagesRef.push(message)
                    .then(() => {
                        messageInput.value = '';
                        messageInput.focus();
                    })
                    .catch((error) => {
                        console.error('Error sending message:', error);
                        alert('Error sending message');
                    });
            }

            // Minimizar chat
            chatMinimize.addEventListener('click', () => {
                liveChat.classList.toggle('minimized');
                chatMinimize.textContent = liveChat.classList.contains('minimized') ? '+' : '‚àí';
            });

            // Escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        })();
    </script>
</body>
</html>
