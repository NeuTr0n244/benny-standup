<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Penguin Stand-Up Comedy</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0a0f;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #curtains {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, #8b0000 0%, #dc143c 50%, #8b0000 100%);
            transition: transform 1.5s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .curtain::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(0,0,0,0.1) 50px, rgba(0,0,0,0.1) 60px);
        }

        .curtain-left { left: 0; }
        .curtain-right { right: 0; }

        #curtains.open .curtain-left { transform: translateX(-100%); }
        #curtains.open .curtain-right { transform: translateX(100%); }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #loading-overlay.hidden { opacity: 0; }

        #loading-text {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            color: #ffea00;
            text-shadow: 0 0 20px #ffea00, 0 0 40px #ffea00;
            margin-bottom: 2rem;
            letter-spacing: 0.3rem;
        }

        #loading-bar-container {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        #loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffea00, #ff2d95);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        #loading-percent {
            color: #fff;
            font-size: 1.2rem;
            margin-top: 1rem;
        }

        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #ui-layer > * { pointer-events: auto; }

        #volume-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        #volume-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #00f5ff;
        }

        /* REMOVIDO - Sistema de piadas */
        #joke-display {
            display: none !important;
        }

        #joke-text {
            display: none !important;
        }

        #nav-buttons {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: #ffffff;
        }

        /* Anima√ß√£o de flutua√ß√£o sutil para About panel (subir e descer 5px) */
        @keyframes floatAbout {
            0%, 100% {
                transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(8deg);
            }
            50% {
                transform: perspective(1000px) translateY(calc(-50% - 5px)) translateX(0) rotateY(8deg);
            }
        }

        /* Anima√ß√£o de flutua√ß√£o sutil para Community panel (subir e descer 5px) */
        @keyframes floatCommunity {
            0%, 100% {
                transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(-8deg);
            }
            50% {
                transform: perspective(1000px) translateY(calc(-50% - 5px)) translateX(0) rotateY(-8deg);
            }
        }

        .panel {
            position: fixed;
            top: 50%;
            width: 350px;
            max-height: 70vh;
            padding: 32px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.8), -5px -5px 20px rgba(255, 255, 255, 0.05);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.4s ease;
            z-index: 100;
            overflow-y: auto;
            transform-style: preserve-3d;
        }

        .panel.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        #about-panel {
            left: 60px;
            transform: perspective(1000px) translateY(-50%) translateX(-30px) rotateY(8deg);
        }

        #about-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 16px 0 0 16px;
        }

        #about-panel.visible {
            transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(8deg);
            animation: floatAbout 4s ease-in-out infinite;
            box-shadow: 25px 25px 50px rgba(0, 0, 0, 0.7);
        }

        #about-panel.visible:hover {
            animation: none;
            transform: perspective(1000px) translateY(calc(-50% - 3px)) translateX(0) rotateY(12deg) scale(1.02);
            box-shadow: 30px 30px 60px rgba(0, 0, 0, 0.8), -5px -5px 25px rgba(255, 255, 255, 0.08);
        }

        #community-panel {
            right: 40px;
            transform: perspective(1000px) translateY(-50%) translateX(30px) rotateY(-8deg);
        }

        #community-panel::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 0 16px 16px 0;
        }

        #community-panel.visible {
            transform: perspective(1000px) translateY(calc(-50% + 0px)) translateX(0) rotateY(-8deg);
            animation: floatCommunity 4s ease-in-out infinite;
            box-shadow: 25px 25px 50px rgba(0, 0, 0, 0.7);
        }

        #community-panel.visible:hover {
            animation: none;
            transform: perspective(1000px) translateY(calc(-50% - 3px)) translateX(0) rotateY(-12deg) scale(1.02);
            box-shadow: -30px 30px 60px rgba(0, 0, 0, 0.8), 5px -5px 25px rgba(255, 255, 255, 0.08);
        }

        .panel-title {
            color: #ffffff;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .panel-content {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.7;
        }

        .panel-content p { margin-bottom: 1rem; }

        .social-btn-panel {
            display: block;
            width: 100%;
            padding: 14px 20px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #ffffff;
            text-decoration: none;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .social-btn-panel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .contract-container { margin: 1.5rem 0; }
        .contract-label { color: #888; font-size: 0.9rem; margin-bottom: 0.5rem; }

        .contract-box {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 0.8rem;
            gap: 0.5rem;
        }

        #contract-address {
            flex: 1;
            color: #fff;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        #copy-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #copy-btn.copied { background: linear-gradient(135deg, #39ff14, #00ff88); }

        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .twitter-btn { background: linear-gradient(135deg, #1da1f2, #0d8bd9); color: #fff; }
        .buy-btn { background: linear-gradient(135deg, #39ff14, #00ff88); color: #000; }

        /* REMOVIDO - Laugh visualizer */
        #laugh-visualizer {
            display: none !important;
        }

        .viz-bar {
            width: 6px;
            height: 30px;
            background: linear-gradient(to top, #ff2d95, #ffea00);
            border-radius: 3px;
            animation: vizPulse 0.3s ease infinite alternate;
        }

        .viz-bar:nth-child(2) { animation-delay: 0.1s; }
        .viz-bar:nth-child(3) { animation-delay: 0.2s; }
        .viz-bar:nth-child(4) { animation-delay: 0.15s; }

        @keyframes vizPulse {
            from { transform: scaleY(0.3); }
            to { transform: scaleY(1); }
        }

        /* ===== CHAT AO VIVO ===== */
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            z-index: 1000;
            font-family: 'Outfit', sans-serif;
        }

        #chat-toggle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(255, 46, 149, 0.4);
            transition: all 0.3s ease;
        }

        #chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 46, 149, 0.6);
        }

        #chat-box {
            display: none;
            flex-direction: column;
            height: 500px;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
        }

        #chat-box.open {
            display: flex;
        }

        #chat-header {
            padding: 16px;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        #chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        #chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 46, 149, 0.5);
            border-radius: 3px;
        }

        .chat-message {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ff2d95;
        }

        .chat-message-time {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 4px;
        }

        .chat-message-nickname {
            font-weight: 600;
            color: #ff2d95;
            margin-right: 6px;
        }

        .chat-message-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            word-wrap: break-word;
        }

        #chat-input-container {
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 8px;
        }

        #chat-input {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
        }

        #chat-input:focus {
            outline: none;
            border-color: #ff2d95;
            background: rgba(255, 255, 255, 0.15);
        }

        #chat-send {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #chat-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 46, 149, 0.4);
        }

        #chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Nickname Modal */
        #nickname-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #nickname-modal.show {
            display: flex;
        }

        #nickname-form {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        #nickname-form h3 {
            color: white;
            margin-bottom: 8px;
            font-size: 24px;
        }

        #nickname-form p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
            font-size: 14px;
        }

        #nickname-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            margin-bottom: 16px;
            text-align: center;
        }

        #nickname-input:focus {
            outline: none;
            border-color: #ff2d95;
            background: rgba(255, 255, 255, 0.15);
        }

        #nickname-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff2d95, #ff6b6b);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #nickname-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 46, 149, 0.4);
        }

        #chat-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
            padding: 40px 20px;
        }

    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="curtains">
        <div class="curtain curtain-left"></div>
        <div class="curtain curtain-right"></div>
    </div>

    <div id="loading-overlay">
        <div id="loading-text">LOADING</div>
        <div id="loading-bar-container">
            <div id="loading-bar"></div>
        </div>
        <div id="loading-percent">0%</div>
    </div>

    <div id="ui-layer">
        <button id="volume-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
        </button>

        <div id="joke-display">
            <div id="joke-text"></div>
        </div>

        <div id="nav-buttons">
            <button class="nav-btn" data-view="about">About</button>
            <button class="nav-btn active" data-view="home">Home</button>
            <button class="nav-btn" data-view="community">Community</button>
        </div>

        <div id="about-panel" class="panel">
            <h2 class="panel-title">About Benny</h2>
            <div class="panel-content">
                <p>Welcome to Benny's Stand-Up Comedy show. The funniest Bird in the crypto world bringing laughs to the blockchain.</p>
                <p>Benny is a digital performer combining cutting-edge 3D animation with blockchain technology, creating a unique entertainment experience in the metaverse.</p>
                <p>Built with Three.js and powered by Web3, Benny represents the future of digital entertainment and community engagement.</p>
            </div>
        </div>

        <div id="community-panel" class="panel">
            <h2 class="panel-title">Community</h2>
            <div class="panel-content">
                <p>Join the Benny community and be part of the revolution in digital entertainment.</p>

                <div style="margin: 24px 0;">
                    <a href="#" class="social-btn-panel" id="twitter-link" target="_blank">Twitter / X</a>
                    <a href="#" class="social-btn-panel" target="_blank">Community</a>
                    <a href="#" class="social-btn-panel" id="buy-link" target="_blank">Buy Token</a>
                </div>

                <div class="contract-container">
                    <div class="contract-label">Contract Address:</div>
                    <div class="contract-box" style="justify-content: center;">
                        <span id="contract-address" style="font-size: 1.5rem; font-weight: bold; color: #fff;">SOON</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="laugh-visualizer">
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
            <div class="viz-bar"></div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // ===== CONFIGURA√á√ÉO =====
        const AUTO_START = false; // DESATIVADO - Usar apenas no lan√ßamento oficial

        const CONFIG = {
            // GLB hosted on Cloudflare R2 - No CORS issues, fast CDN delivery
            modelPath: 'https://pub-8d7b1a002dc7461881f41950b1c60105.r2.dev/mr_penguin.glb',
            contractAddress: '7UxJfQKSKvnXQPvMQDH9YPMEJg8z3ZrD4KwXmXXXpump',
            twitterUrl: 'https://x.com/mrpenguinstand',
            buyUrl: 'https://pump.fun/7UxJfQKSKvnXQPvMQDH9YPMEJg8z3ZrD4KwXmXXXpump',

            rotations: {
                home: 0,
                about: 0.4,
                community: -0.4
            },

            jokes: [
                "Por que o pinguim n√£o sente frio? Porque ele nasceu no gelo! ü•∂",
                "Eu investi em cripto e agora moro num iglu... de luxo! üè†",
                "Qual √© o animal mais engra√ßado? O pinguim! Porque j√° nasce de smoking! ü§µ",
                "Minha carteira cripto √© t√£o fria quanto a Ant√°rtida... mas pelo menos eu tenho estilo! üòé",
                "Por que pinguins s√£o √≥timos traders? Porque sabem quando o mercado est√° congelado! üìâ"
            ],

            jokeDisplayTime: 5000,
            jokePauseTime: 1500
        };

        // ===== VARI√ÅVEIS GLOBAIS =====
        let scene, camera, renderer, mixer, model;
        let currentView = 'home';
        let isMuted = false;
        let audioContext, laughBuffer;
        let jokeInterval;
        let currentJokeIndex = 0;
        let isAudioUnlocked = false;
        
        // C√¢meras do GLB
        let glbCameras = {};
        let targetCameraPosition = new THREE.Vector3();
        let targetCameraQuaternion = new THREE.Quaternion();
        
        // Velocidade da anima√ß√£o (1.0 = normal, 0.5 = metade, 2.0 = dobro)
        const ANIMATION_SPEED = 2.5; // BEM mais r√°pido

        // ===== ELEMENTOS DOM =====
        const curtains = document.getElementById('curtains');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingBar = document.getElementById('loading-bar');
        const loadingPercent = document.getElementById('loading-percent');
        const volumeBtn = document.getElementById('volume-btn');
        const jokeDisplay = document.getElementById('joke-display');
        const jokeText = document.getElementById('joke-text');
        const navButtons = document.querySelectorAll('.nav-btn');
        const aboutPanel = document.getElementById('about-panel');
        const communityPanel = document.getElementById('community-panel');
        const laughVisualizer = document.getElementById('laugh-visualizer');
        const contractAddressEl = document.getElementById('contract-address');
        const copyBtn = document.getElementById('copy-btn');
        const twitterLink = document.getElementById('twitter-link');
        const buyLink = document.getElementById('buy-link');

        // ===== INICIALIZA√á√ÉO =====
        function init() {
            // contractAddress agora √© est√°tico ("SOON") no HTML
            twitterLink.href = CONFIG.twitterUrl;
            buyLink.href = CONFIG.buyUrl;

            // Cria cena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Cria c√¢mera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);

            // ===== RENDERER - QUALIDADE E REALISMO =====
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance",
                alpha: false,
                stencil: false
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // Cor e tone mapping realista
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 0.7; // Mais escuro para manter efeito de spotlight
            
            // Sombras de alta qualidade
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.shadowMap.autoUpdate = true;
            
            // F√≠sica de luz realista
            renderer.useLegacyLights = false;
            
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            loadModel();
            setupAudio();
            setupEventListeners();
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        // ===== CARREGAMENTO DO MODELO =====
        function loadModel() {
            const loader = new GLTFLoader();

            loader.load(
                CONFIG.modelPath + '?t=' + Date.now(), // Evita cache
                (gltf) => {
                    console.log('‚úÖ GLB carregado!');

                    model = gltf.scene;
                    scene.add(model);

                    // ===== C√ÇMERAS DO GLB =====
                    if (gltf.cameras && gltf.cameras.length > 0) {
                        console.log('üì∑ C√¢meras encontradas:', gltf.cameras.length);
                        
                        // Percorre a cena para encontrar as c√¢meras com suas posi√ß√µes
                        gltf.scene.traverse((child) => {
                            if (child.isCamera) {
                                const camName = child.name.toLowerCase();
                                glbCameras[camName] = {
                                    position: child.position.clone(),
                                    quaternion: child.quaternion.clone(),
                                    fov: child.fov || 50
                                };
                                console.log('üì∑ C√¢mera salva:', child.name);
                            }
                        });
                        
                        // Se n√£o encontrou nas traversals, usa as c√¢meras do array
                        if (Object.keys(glbCameras).length === 0) {
                            gltf.cameras.forEach((cam, index) => {
                                const camName = cam.name ? cam.name.toLowerCase() : `camera_${index}`;
                                glbCameras[camName] = {
                                    position: cam.position.clone(),
                                    quaternion: cam.quaternion.clone(),
                                    fov: cam.fov || 50
                                };
                                console.log('üì∑ C√¢mera salva (array):', camName);
                            });
                        }
                        
                        // Define c√¢mera inicial (home ou primeira dispon√≠vel)
                        const homeCamera = glbCameras['home'] || glbCameras['camera'] || Object.values(glbCameras)[0];
                        if (homeCamera) {
                            camera.position.copy(homeCamera.position);
                            camera.quaternion.copy(homeCamera.quaternion);
                            camera.fov = homeCamera.fov;
                            camera.updateProjectionMatrix();
                            
                            targetCameraPosition.copy(homeCamera.position);
                            targetCameraQuaternion.copy(homeCamera.quaternion);
                        }
                        
                        console.log('‚úÖ C√¢meras configuradas!');
                        console.log('üì∑ C√¢meras dispon√≠veis:', Object.keys(glbCameras));
                    } else {
                        camera.position.set(0, 2, 6);
                        camera.lookAt(0, 1.2, 0);
                        targetCameraPosition.copy(camera.position);
                        targetCameraQuaternion.copy(camera.quaternion);
                        console.log('‚ö†Ô∏è Nenhuma c√¢mera no GLB, usando padr√£o');
                    }

                    // ===== LUZES DO GLB - USANDO SOMENTE AS DO BLENDER =====
                    let hasLights = false;
                    gltf.scene.traverse((child) => {
                        if (child.isLight) {
                            hasLights = true;
                            
                            const lightName = child.name.toLowerCase();
                            
                            // Luz PRINCIPAL (foco no personagem) - mais forte
                            if (lightName.includes('principal') || lightName.includes('main') || lightName.includes('key')) {
                                child.intensity = child.intensity * 0.001; // Mais forte
                                console.log('üí° LUZ PRINCIPAL:', child.name, '- Intensidade:', child.intensity.toFixed(2));
                            } else {
                                // Outras luzes - mant√©m mais fracas
                                child.intensity = child.intensity * 0.0005;
                                console.log('üí° Luz secund√°ria:', child.name, '- Intensidade:', child.intensity.toFixed(2));
                            }
                            
                            // Sombras de alta qualidade
                            child.castShadow = true;
                            
                            if (child.isSpotLight) {
                                child.penumbra = 0.5;
                                child.decay = 2;
                                
                                child.shadow.mapSize.width = 2048;
                                child.shadow.mapSize.height = 2048;
                                child.shadow.camera.near = 0.1;
                                child.shadow.camera.far = 50;
                                child.shadow.bias = -0.0001;
                                child.shadow.normalBias = 0.02;
                                child.shadow.radius = 4;
                            }
                            
                            if (child.isPointLight) {
                                child.decay = 2;
                                child.shadow.mapSize.width = 1024;
                                child.shadow.mapSize.height = 1024;
                                child.shadow.bias = -0.0001;
                                child.shadow.radius = 3;
                            }
                        }
                    });

                    console.log('üí° Usando SOMENTE as luzes do GLB!');

                    // SEM luz ambiente extra - apenas as luzes do GLB

                    // Se n√£o tiver luzes no GLB, adiciona luzes b√°sicas realistas
                    if (!hasLights) {
                        const keyLight = new THREE.SpotLight(0xffffff, 50);
                        keyLight.position.set(5, 10, 5);
                        keyLight.castShadow = true;
                        keyLight.shadow.mapSize.width = 2048;
                        keyLight.shadow.mapSize.height = 2048;
                        keyLight.shadow.bias = -0.0001;
                        keyLight.penumbra = 0.5;
                        scene.add(keyLight);
                        
                        const fillLight = new THREE.DirectionalLight(0x8888ff, 0.3);
                        fillLight.position.set(-5, 5, -5);
                        scene.add(fillLight);
                    }

                    // ===== MATERIAIS - CONFIGURA√á√ÉO REALISTA =====
                    model.traverse((child) => {
                        if (child.isMesh) {
                            // Sombras
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            if (child.material) {
                                const materials = Array.isArray(child.material) ? child.material : [child.material];
                                materials.forEach(mat => {
                                    // Configura texturas com colorSpace correto
                                    if (mat.map) {
                                        mat.map.colorSpace = THREE.SRGBColorSpace;
                                        mat.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                                    }
                                    if (mat.emissiveMap) {
                                        mat.emissiveMap.colorSpace = THREE.SRGBColorSpace;
                                    }
                                    
                                    // Configura√ß√µes PBR realistas
                                    if (mat.isMeshStandardMaterial || mat.isMeshPhysicalMaterial) {
                                        mat.envMapIntensity = 0.5;
                                    }
                                    
                                    mat.needsUpdate = true;
                                });
                            }
                        }
                    });
                    
                    console.log('‚úÖ Materiais configurados');

                    // ===== CORRE√á√ÉO DE NORMAIS PARA TODO O CEN√ÅRIO (EXCETO PERSONAGEM) =====
                    model.traverse((child) => {
                        if (child.isMesh) {
                            const name = child.name.toLowerCase();
                            
                            // Lista de nomes que identificam o PERSONAGEM (n√£o aplicar corre√ß√£o)
                            const isCharacter = 
                                name.includes('penguin') || 
                                name.includes('personagem') ||
                                name.includes('character') ||
                                name.includes('sketchfab') ||
                                name.includes('mr_penguin') ||
                                name.includes('tripo') ||
                                name.includes('body') ||
                                name.includes('head') ||
                                name.includes('arm') ||
                                name.includes('leg') ||
                                name.includes('hand') ||
                                name.includes('foot') ||
                                name.includes('mesh_0') ||
                                (child.parent && child.parent.name.toLowerCase().includes('armature'));
                            
                            // Se N√ÉO for personagem, aplica corre√ß√£o de normais apenas
                            if (!isCharacter) {
                                // Recalcula normais da geometria para suavizar
                                child.geometry.computeVertexNormals();
                                
                                if (child.material) {
                                    const materials = Array.isArray(child.material) ? child.material : [child.material];
                                    materials.forEach(mat => {
                                        // Remove normal/bump map que podem causar artefatos
                                        if (mat.normalMap) mat.normalMap = null;
                                        if (mat.bumpMap) mat.bumpMap = null;
                                        
                                        // For√ßa smooth shading
                                        mat.flatShading = false;
                                        
                                        mat.needsUpdate = true;
                                    });
                                }
                            }
                        }
                    });
                    
                    console.log('‚úÖ Normais do cen√°rio corrigidas');

                    // ===== ANIMA√á√ïES - TOCAR COMPLETA EM LOOP =====
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        
                        // Configura velocidade da anima√ß√£o
                        mixer.timeScale = ANIMATION_SPEED;
                        
                        gltf.animations.forEach((clip) => {
                            console.log('üé¨ Anima√ß√£o encontrada:', clip.name, '- Dura√ß√£o:', clip.duration.toFixed(2) + 's', '- Tracks:', clip.tracks.length);
                            
                            // IGNORA anima√ß√µes muito curtas (menos de 15 segundos)
                            // A "Armature" de 8.63s est√° cortada, ignoramos ela
                            if (clip.duration < 15) {
                                console.log('‚è≠Ô∏è Ignorando anima√ß√£o curta:', clip.name);
                                return; // Pula para pr√≥xima
                            }
                            
                            const action = mixer.clipAction(clip);
                            
                            // Garante que toca em LOOP infinito
                            action.setLoop(THREE.LoopRepeat, Infinity);
                            
                            // Come√ßa do in√≠cio
                            action.reset();
                            
                            // Peso total (100% da anima√ß√£o)
                            action.setEffectiveWeight(1);
                            
                            // Tempo total (n√£o corta)
                            action.setEffectiveTimeScale(1);
                            
                            // N√£o para no final
                            action.clampWhenFinished = false;
                            
                            // Inicia a anima√ß√£o
                            action.play();
                            
                            console.log('‚úÖ Anima√ß√£o ativada:', clip.name);
                        });
                        
                        console.log('‚úÖ Anima√ß√µes iniciadas (velocidade:', ANIMATION_SPEED + 'x)');
                    } else {
                        console.log('‚ö†Ô∏è Nenhuma anima√ß√£o encontrada no GLB!');
                    }

                    openCurtains();
                },
                (xhr) => {
                    if (xhr.total > 0) {
                        const percent = Math.round((xhr.loaded / xhr.total) * 100);
                        loadingBar.style.width = percent + '%';
                        loadingPercent.textContent = percent + '%';
                    }
                },
                (error) => {
                    console.error('‚ùå Erro:', error);
                    loadingPercent.textContent = 'Erro ao carregar';
                }
            );
        }

        function openCurtains() {
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                curtains.classList.add('open');

                // Inicia automaticamente em 2 segundos ap√≥s carregar
                if (AUTO_START) {
                    console.log('üé¨ Iniciando Benny automaticamente...');
                    setTimeout(() => initializeBenny(), 2000);
                }
            }, 500);
        }

        // ===== √ÅUDIO =====
        function setupAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                generateLaughSound();
            } catch (e) {}
        }

        function unlockAudio() {
            if (!isAudioUnlocked && audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => { isAudioUnlocked = true; });
            }
        }

        function generateLaughSound() {
            if (!audioContext) return;
            const sampleRate = audioContext.sampleRate;
            const duration = 1.5;
            const bufferSize = sampleRate * duration;
            laughBuffer = audioContext.createBuffer(1, bufferSize, sampleRate);
            const data = laughBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                const t = i / sampleRate;
                const env = Math.exp(-t * 2) * 0.3;
                data[i] = (Math.random() * 2 - 1) * env + Math.sin(Math.PI * 200 * t) * env * 0.5;
            }
        }

        function playLaugh() {
            if (!audioContext || !laughBuffer || isMuted) return;
            unlockAudio();
            const source = audioContext.createBufferSource();
            source.buffer = laughBuffer;
            const gain = audioContext.createGain();
            gain.gain.value = 0.15;
            source.connect(gain);
            gain.connect(audioContext.destination);
            source.start(0);
            laughVisualizer.classList.add('active');
            setTimeout(() => laughVisualizer.classList.remove('active'), 1500);
        }

        // ===== SISTEMA DE PIADAS COM IA + BUFFER =====
        let isPlayingJoke = false;
        let jokeLoopEnabled = false;
        let jokeBuffer = []; // Buffer para armazenar piadas pr√©-carregadas
        let isPreloading = false;
        const MAX_BUFFER_SIZE = 2; // Manter sempre 2 piadas no buffer

        // Fun√ß√£o para pr√©-carregar uma piada e adicionar ao buffer
        async function preloadJoke() {
            if (isPreloading || jokeBuffer.length >= MAX_BUFFER_SIZE) return;
            isPreloading = true;

            try {
                console.log(`üì¶ Pr√©-carregando piada... (Buffer: ${jokeBuffer.length}/${MAX_BUFFER_SIZE})`);

                const response = await fetch('/api/generate-joke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to generate joke');
                }

                // Adicionar ao buffer
                jokeBuffer.push({
                    text: data.joke,
                    audioBase64: data.audio,
                    audioFormat: data.audioFormat || 'audio/mpeg'
                });

                console.log(`‚úÖ Piada adicionada ao buffer! (${jokeBuffer.length}/${MAX_BUFFER_SIZE})`);

            } catch (error) {
                console.error('‚ùå Erro ao pr√©-carregar piada:', error);
            } finally {
                isPreloading = false;
            }
        }

        // Fun√ß√£o para tocar pr√≥xima piada do buffer
        async function playNextJoke() {
            if (isPlayingJoke) return;

            // Se buffer vazio, gerar piada na hora (fallback)
            if (jokeBuffer.length === 0) {
                console.log('‚ö†Ô∏è Buffer vazio! Gerando piada na hora...');
                await preloadJoke();
                if (jokeBuffer.length === 0) {
                    console.error('‚ùå Falha ao gerar piada');
                    if (jokeLoopEnabled && currentView === 'home') {
                        setTimeout(() => playNextJoke(), 1000); // Retry em 1s
                    }
                    return;
                }
            }

            isPlayingJoke = true;

            // Pegar primeira piada do buffer
            const joke = jokeBuffer.shift();
            console.log(`üé§ BENNY DISSE: ${joke.text}`);
            console.log(`üìä Buffer restante: ${jokeBuffer.length}/${MAX_BUFFER_SIZE}`);

            // Disparar pr√©-carregamento de nova piada em background
            preloadJoke();

            try {
                // Converter base64 para audio blob
                const audioData = atob(joke.audioBase64);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }
                const audioBlob = new Blob([audioArray], { type: joke.audioFormat });
                const audioUrl = URL.createObjectURL(audioBlob);

                // Criar e tocar √°udio
                const audio = new Audio(audioUrl);

                // Quando terminar
                audio.addEventListener('ended', () => {
                    URL.revokeObjectURL(audioUrl);
                    isPlayingJoke = false;

                    // Pr√≥xima piada IMEDIATAMENTE
                    if (jokeLoopEnabled && currentView === 'home') {
                        playNextJoke(); // Transi√ß√£o instant√¢nea!
                    }
                });

                // Handler de erro no √°udio
                audio.addEventListener('error', (e) => {
                    console.error('‚ùå Erro ao tocar √°udio:', e);
                    URL.revokeObjectURL(audioUrl);
                    isPlayingJoke = false;

                    // Tentar pr√≥xima piada
                    if (jokeLoopEnabled && currentView === 'home') {
                        playNextJoke();
                    }
                });

                // Desbloquear √°udio e tocar
                unlockAudio();
                await audio.play();

            } catch (error) {
                console.error('‚ùå Erro ao tocar piada:', error);
                isPlayingJoke = false;

                // Tentar pr√≥xima piada
                if (jokeLoopEnabled && currentView === 'home') {
                    playNextJoke();
                }
            }
        }

        // ===== FUN√á√ïES DE CONTROLE (via console para desenvolvimento) =====
        async function initializeBenny() {
            if (jokeLoopEnabled) {
                console.log('‚ö†Ô∏è Benny j√° est√° ativo!');
                return;
            }
            jokeLoopEnabled = true;
            console.log('üé≠ Sistema de piadas ativado!');
            console.log('üì¶ Pr√©-carregando buffer inicial (2 piadas)...');

            // Pr√©-carregar 2 piadas antes de come√ßar
            await preloadJoke();
            await preloadJoke();

            console.log('‚úÖ Buffer pronto! Iniciando Benny...');
            playNextJoke();
        }

        // Expor controles no console para desenvolvimento
        window.startBenny = initializeBenny;
        window.stopBenny = function() {
            jokeLoopEnabled = false;
            console.log('‚è∏Ô∏è Sistema de piadas pausado.');
            console.log(`üìä Buffer atual: ${jokeBuffer.length} piadas`);
        };

        // ===== PIADAS (DESATIVADO) =====
        /*
        function startJokeLoop() {
            showJoke();
            jokeInterval = setInterval(() => {
                hideJoke();
                setTimeout(() => {
                    currentJokeIndex = (currentJokeIndex + 1) % CONFIG.jokes.length;
                    showJoke();
                }, CONFIG.jokePauseTime);
            }, CONFIG.jokeDisplayTime + CONFIG.jokePauseTime);
        }

        function showJoke() {
            if (currentView !== 'home') return;
            jokeText.textContent = CONFIG.jokes[currentJokeIndex];
            jokeDisplay.classList.add('visible');
            setTimeout(() => playLaugh(), 2000);
        }

        function hideJoke() {
            jokeDisplay.classList.remove('visible');
        }

        function stopJokeLoop() {
            if (jokeInterval) {
                clearInterval(jokeInterval);
                jokeInterval = null;
            }
            hideJoke();
        }
        */

        // ===== NAVEGA√á√ÉO =====
        function changeView(view) {
            if (view === currentView) return;
            currentView = view;

            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            aboutPanel.classList.remove('visible');
            communityPanel.classList.remove('visible');

            // ===== TROCA DE C√ÇMERA BASEADO NA VIEW =====
            // Procura c√¢mera pelo nome (about, community, home)
            let targetCamera = null;
            
            // Tenta encontrar c√¢mera com nome exato ou similar
            const possibleNames = [
                view,
                view + '_camera',
                'camera_' + view,
                'cam_' + view
            ];
            
            for (const name of possibleNames) {
                if (glbCameras[name]) {
                    targetCamera = glbCameras[name];
                    console.log('üì∑ Trocando para c√¢mera:', name);
                    break;
                }
            }
            
            // Se n√£o encontrou, usa a c√¢mera home ou a primeira dispon√≠vel
            if (!targetCamera) {
                targetCamera = glbCameras['home'] || glbCameras['camera'] || Object.values(glbCameras)[0];
                console.log('üì∑ C√¢mera n√£o encontrada para', view, '- usando padr√£o');
            }
            
            // Define posi√ß√£o/rota√ß√£o alvo para transi√ß√£o suave
            if (targetCamera) {
                targetCameraPosition.copy(targetCamera.position);
                targetCameraQuaternion.copy(targetCamera.quaternion);
                
                // Atualiza FOV se diferente
                if (camera.fov !== targetCamera.fov) {
                    camera.fov = targetCamera.fov;
                    camera.updateProjectionMatrix();
                }
            }

            // Sistema de piadas continua rodando independente da view
            // (usu√°rio controla via startBenny/stopBenny no console)

            if (view === 'about') {
                setTimeout(() => aboutPanel.classList.add('visible'), 500);
            } else if (view === 'community') {
                setTimeout(() => communityPanel.classList.add('visible'), 500);
            }
        }

        // ===== EVENTOS =====
        function setupEventListeners() {
            document.addEventListener('click', unlockAudio, { once: true });

            volumeBtn.addEventListener('click', () => {
                isMuted = !isMuted;
                volumeBtn.textContent = isMuted ? 'üîá' : 'üîä';
            });

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => changeView(btn.dataset.view));
            });

            // copyBtn removido - contract address agora √© "SOON" est√°tico

            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') changeView('about');
                else if (e.key === 'ArrowRight') changeView('community');
                else if (e.key === 'Escape' || e.key === ' ') { changeView('home'); e.preventDefault(); }
                else if (e.key === 'm' || e.key === 'M') volumeBtn.click();
            });
        }

        // ===== LOOP DE ANIMA√á√ÉO =====
        const clock = new THREE.Clock();
        const CAMERA_LERP_SPEED = 0.03; // Velocidade da transi√ß√£o de c√¢mera (0.01 = lento, 0.1 = r√°pido)

        function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);

            // Transi√ß√£o suave da posi√ß√£o da c√¢mera
            camera.position.lerp(targetCameraPosition, CAMERA_LERP_SPEED);
            
            // Transi√ß√£o suave da rota√ß√£o da c√¢mera
            camera.quaternion.slerp(targetCameraQuaternion, CAMERA_LERP_SPEED);

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>

    <!-- ===== CHAT AO VIVO ===== -->
    <div id="chat-container">
        <div id="chat-box">
            <div id="chat-header">
                <h3>üí¨ Live Chat</h3>
                <button id="chat-close">√ó</button>
            </div>
            <div id="chat-messages">
                <div id="chat-empty">Seja o primeiro a enviar uma mensagem!</div>
            </div>
            <div id="chat-input-container">
                <input
                    type="text"
                    id="chat-input"
                    placeholder="Digite sua mensagem..."
                    maxlength="500"
                    disabled
                />
                <button id="chat-send" disabled>Enviar</button>
            </div>
        </div>
        <button id="chat-toggle">üí¨</button>
    </div>

    <!-- Modal de Nickname -->
    <div id="nickname-modal">
        <div id="nickname-form">
            <h3>Entrar no Chat</h3>
            <p>Escolha um nickname para participar da conversa</p>
            <input
                type="text"
                id="nickname-input"
                placeholder="Seu nickname..."
                maxlength="20"
            />
            <button id="nickname-submit">Entrar no Chat</button>
        </div>
    </div>

    <script>
        // ===== SISTEMA DE CHAT AO VIVO =====
        (function() {
            const chatContainer = document.getElementById('chat-container');
            const chatBox = document.getElementById('chat-box');
            const chatToggle = document.getElementById('chat-toggle');
            const chatClose = document.getElementById('chat-close');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatEmpty = document.getElementById('chat-empty');

            const nicknameModal = document.getElementById('nickname-modal');
            const nicknameInput = document.getElementById('nickname-input');
            const nicknameSubmit = document.getElementById('nickname-submit');

            let userNickname = null;
            let pollingInterval = null;
            let lastMessageId = null;

            // Verificar se j√° tem nickname salvo
            const savedNickname = localStorage.getItem('chat_nickname');
            if (savedNickname) {
                userNickname = savedNickname;
                enableChat();
            }

            // Toggle chat
            chatToggle.addEventListener('click', () => {
                if (!userNickname) {
                    nicknameModal.classList.add('show');
                } else {
                    chatBox.classList.add('open');
                    chatToggle.style.display = 'none';
                    loadMessages();
                    startPolling();
                }
            });

            // Fechar chat
            chatClose.addEventListener('click', () => {
                chatBox.classList.remove('open');
                chatToggle.style.display = 'flex';
                stopPolling();
            });

            // Nickname modal
            nicknameSubmit.addEventListener('click', submitNickname);
            nicknameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitNickname();
            });

            function submitNickname() {
                const nickname = nicknameInput.value.trim();
                if (!nickname) {
                    alert('Por favor, digite um nickname');
                    return;
                }
                if (nickname.length > 20) {
                    alert('Nickname muito longo (max 20 caracteres)');
                    return;
                }

                userNickname = nickname;
                localStorage.setItem('chat_nickname', nickname);
                nicknameModal.classList.remove('show');
                chatBox.classList.add('open');
                chatToggle.style.display = 'none';
                enableChat();
                loadMessages();
                startPolling();
            }

            function enableChat() {
                chatInput.disabled = false;
                chatSend.disabled = false;
            }

            // Enviar mensagem
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message || !userNickname) return;

                chatSend.disabled = true;
                chatInput.disabled = true;

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            nickname: userNickname,
                            message: message
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        chatInput.value = '';
                        loadMessages();
                    } else {
                        alert('Erro ao enviar mensagem: ' + data.error);
                    }
                } catch (error) {
                    console.error('Erro ao enviar mensagem:', error);
                    alert('Erro ao enviar mensagem');
                } finally {
                    chatSend.disabled = false;
                    chatInput.disabled = false;
                    chatInput.focus();
                }
            }

            // Carregar mensagens
            async function loadMessages() {
                try {
                    const response = await fetch('/api/chat');
                    const data = await response.json();

                    if (data.success && data.messages.length > 0) {
                        chatEmpty.style.display = 'none';
                        renderMessages(data.messages);
                    } else {
                        chatEmpty.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erro ao carregar mensagens:', error);
                }
            }

            // Renderizar mensagens
            function renderMessages(messages) {
                // Remover mensagens antigas (manter apenas chat-empty)
                const oldMessages = chatMessages.querySelectorAll('.chat-message');
                oldMessages.forEach(msg => msg.remove());

                // Adicionar novas mensagens
                messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = 'chat-message';
                    messageEl.dataset.id = msg.id;

                    const time = new Date(msg.timestamp).toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    messageEl.innerHTML = `
                        <div class="chat-message-time">${time}</div>
                        <div>
                            <span class="chat-message-nickname">${escapeHtml(msg.nickname)}:</span>
                            <span class="chat-message-text">${escapeHtml(msg.message)}</span>
                        </div>
                    `;

                    chatMessages.appendChild(messageEl);
                });

                // Scroll para o final
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Atualizar √∫ltimo ID
                if (messages.length > 0) {
                    lastMessageId = messages[messages.length - 1].id;
                }
            }

            // Escape HTML para seguran√ßa
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Polling para novas mensagens
            function startPolling() {
                if (pollingInterval) return;
                pollingInterval = setInterval(loadMessages, 3000); // A cada 3 segundos
            }

            function stopPolling() {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }

            // Cleanup ao fechar p√°gina
            window.addEventListener('beforeunload', stopPolling);
        })();
    </script>
</body>
</html>
